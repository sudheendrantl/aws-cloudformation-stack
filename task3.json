{

    "AWSTemplateFormatVersion": "2010-09-09",

    "Description": "EC2, Kinesis Data Stream, Dynamo DB, SNS, S3 and Lambda creation (v11)",

    "Parameters": {

        "AnomalyDataDetectorCodeBuildProjectName": {
            "Description": "CodeBuild Project name",
            "Type": "String",
            "Default": "AnomalyDataDetector"
        },

        "AnomalyDataDetectorCodeCommitRepositoryName": {
            "Description": "CodeCommit Repository name",
            "Type": "String",
            "Default": "AnomalyDataDetector"
        },

        "AnomalyDataDetectorCodeDeployAppName": {
            "Description": "CodeDeploy Application name",
            "Type": "String",
            "Default": "AnomalyDataDetector"
        },

        "AnomalyDataDetectorCodeDeploymentGroupName": {
            "Description": "CodeDeploy Deployment Group name",
            "Type": "String",
            "Default": "AnomalyDataDetectorGroup"
        },

        "AnomalyDataDetectorCodePipelineName": {
            "Description": "CodePipeline name",
            "Type": "String",
            "Default": "AnomalyDataDetector"
        },

        "AnomalyDataDetectorDynamoDBTableName": {
            "Description": "Dynamo Database Table name",
            "Type": "String",
            "Default": "m03p02_anomaly_data"
        },

        "AnomalyDataDetectorEC2Keyname": {
            "Description": "Name of EC2 key",
            "Type": "String",
            "Default": "anomalydetectorkey"
        },

        "AnomalyDataDetectorKinesisDataStreamName": {
            "Description": "Kinesis DataStream name",
            "Type": "String",
            "Default": "m03p02_raw_data_stream"
        },

        "AnomalyDataDetectorSNSAlertTopicName": {
            "Description": "SNS Alert Topic Name",
            "Type": "String",
            "Default": "m03p02_anomaly_alerts"
        },

		"AnomalyDataDetectorSubscriptionEmailID":{
            "Description": "Email ID of subscriber of the Alert topic",
            "Type": "String",
            "Default": "sudheendran@hotmail.com"
		},

		"AnomalyDataDetectorS3BucketName":{
            "Description": "Name of S3 to be created for storing Anomaly Detection Source files",
            "Type": "String",
            "Default": "anomalydetections3bucket"
		},

		"AnomalyDataGeneratorS3KeyName":{
            "Description": "Name of S3 Key (ZIP file name) to be used to locate the raw data generator source file",
            "Type": "String",
            "Default": "raw_data.zip"
		},

		"AnomalyDataDetectorLambdaS3KeyName":{
            "Description": "Name of S3 Key (ZIP file name) to be used to locate the lambda handler source file",
            "Type": "String",
            "Default": "anomaly_detection.zip"
		},

		"AnomalyDataDetectorLambdaFunctionName":{
            "Description": "Name of Lambda function to create",
            "Type": "String",
            "Default": "anomaly_detection"
		},

		"AnomalyDataDetectorLambdaEnvName":{
            "Description": "Runtime for the Lambda function to be created e.g Python3.11, Node.js etc)",
            "Type": "String",
            "Default": "python3.11"
		},

        "AnomalyDataDetectorEC2InstanceName": {
            "Description": "Name of the EC2 machine to be created",
            "Type": "String",
            "Default": "anomalywebserver"
        },
		
        "AnomalyDataDetectorEC2InstanceType": {
            "Description": "EC2 instance type",
            "Type": "String",
            "Default": "t2.micro"
        },

        "AnomalyDataDetectorEC2InstanceAMI": {
            "Description": "EC2 Instance AMI",
            "Type": "String",
            "Default": "ami-0261755bbcb8c4a84"
        },

		"AnomalyDataDetectorEC2InstanceTagName":{
            "Description": "Tag to be created for EC2",
            "Type": "String",
            "Default": "Name"
		},

        "AnomalyDataDetectorIdentifierTagName": {
            "Description": "Tag Name to be used while creating resources",
            "Type": "String",
            "Default": "Identifier"
        },

        "AnomalyDataDetectorIdentifierTagValue": {
            "Description": "Tag value to be used while creating resources",
            "Type": "String",
            "Default": "AnomalyDataDetector"
        }

    },

    "Resources": {

        "AnomalyDataDetectorEC2AdminRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
				"ManagedPolicyArns" : ["arn:aws:iam::aws:policy/AdministratorAccess"],
				"RoleName" : "AnomalyDataDetectorEC2AdminRole",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

        "AnomalyDataDetectorEC2AdminRoleInstance": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "AnomalyDataDetectorEC2AdminRole"
                    }
                ],
				"InstanceProfileName" : "AnomalyDataDetectorEC2AdminRole"
            }
        },

        "AnomalyDataDetectorLambdaAdminRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
				"ManagedPolicyArns" : ["arn:aws:iam::aws:policy/AdministratorAccess"],
				"RoleName" : "AnomalyDataDetectorLambdaAdminRole",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

        "AnomalyDataDetectorLambdaAdminRoleInstance": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "AnomalyDataDetectorLambdaAdminRole"
                    }
                ],
				"InstanceProfileName" : "AnomalyDataDetectorLambdaAdminRole"
            }
        },

        "AnomalyDataDetectorCodeDeployAdminRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "codedeploy.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
				"ManagedPolicyArns" : ["arn:aws:iam::aws:policy/AdministratorAccess"],
				"RoleName" : "AnomalyDataDetectorCodeDeployAdminRole",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

        "AnomalyDataDetectorCodeDeployAdminRoleInstance": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "AnomalyDataDetectorCodeDeployAdminRole"
                    }
                ],
				"InstanceProfileName" : "AnomalyDataDetectorCodeDeployAdminRole"
            }
        },

        "AnomalyDataDetectorCodeBuildAdminRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "codebuild.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
				"ManagedPolicyArns" : ["arn:aws:iam::aws:policy/AdministratorAccess"],
				"RoleName" : "AnomalyDataDetectorCodeBuildAdminRole",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

        "AnomalyDataDetectorCodeBuildAdminRoleInstance": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "AnomalyDataDetectorCodeBuildAdminRole"
                    }
                ],
				"InstanceProfileName" : "AnomalyDataDetectorCodeBuildAdminRole"
            }
        },

        "AnomalyDataDetectorCodePipelineAdminRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "codepipeline.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
				"ManagedPolicyArns" : ["arn:aws:iam::aws:policy/AdministratorAccess"],
				"RoleName" : "AnomalyDataDetectorCodePipelineAdminRole",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

		"AnomalyDataDetectorVPC": {
			"Type": "AWS::EC2::VPC",
			"Properties": {
				"CidrBlock": "10.0.0.0/16",
				"EnableDnsHostnames": "true",
				"EnableDnsSupport": "true",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

		"AnomalyDataDetectorSubnet": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "AnomalyDataDetectorVPC"
				},
				"CidrBlock": "10.0.1.0/24",
				"AvailabilityZone": "us-east-1a",
				"MapPublicIpOnLaunch": "true",
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},
		
       "AnomalyDataDetectorSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable HTTP, HTTPS, SSH, All ingress",
                "VpcId": {
                    "Ref": "AnomalyDataDetectorVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": -1,
                        "FromPort": 0,
                        "ToPort": 0,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
            }
        },
		
		"AnomalyDataDetectorIG": {
			"Type": "AWS::EC2::InternetGateway",
			"Properties": {
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
			
		},
		
		"AnomalyDataDetectorRouteTable" : {
			"Type" : "AWS::EC2::RouteTable",
			"Properties" : {
				"VpcId" : {
					"Ref" : "AnomalyDataDetectorVPC"
				},
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

		"AnomalyDataDetectorSubnetRouteTableAssociation" : {
		   "Type" : "AWS::EC2::SubnetRouteTableAssociation",
		   "Properties" : {
			   "SubnetId" : { 
					"Ref" : "AnomalyDataDetectorSubnet" 
				},
				"RouteTableId" : { 
					"Ref" : "AnomalyDataDetectorRouteTable" 
				}
			}
		},

		"AnomalyDataDetectorRoute" : {
			"Type" : "AWS::EC2::Route",
			"Properties" : {
				"RouteTableId" : { 
					"Ref" : "AnomalyDataDetectorRouteTable" 
				},
				"DestinationCidrBlock" : "0.0.0.0/0",
				"GatewayId" : { 
					"Ref" : "AnomalyDataDetectorIG"
				}
			}
		},

		"AnomalyDataDetectorVPCGatewayAttachment" : {
			"Type" : "AWS::EC2::VPCGatewayAttachment",
			"Properties" : {
				"InternetGatewayId" : {
					"Ref" : "AnomalyDataDetectorIG"
				},
				"VpcId" : {
					"Ref" : "AnomalyDataDetectorVPC"
				}
			}
		},

		"AnomalyDataDetectorEC2KeyPair": {
			"Type" : "AWS::EC2::KeyPair",
			"Properties" : {
				"KeyName" : {
					"Ref" : "AnomalyDataDetectorEC2Keyname"
				},
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},		

        "AnomalyDataDetectorEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
				"IamInstanceProfile" : {
					"Ref" : "AnomalyDataDetectorEC2AdminRole"
				},
				"Tags": [
					{
						"Key" : {
							"Ref" : "AnomalyDataDetectorEC2InstanceTagName"
						},
						"Value" : {
							"Ref": "AnomalyDataDetectorEC2InstanceName"
						}
					},
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				],                "InstanceType": {
                    "Ref": "AnomalyDataDetectorEC2InstanceType"
                },
                "ImageId": {
                    "Ref": "AnomalyDataDetectorEC2InstanceAMI"
                },
				"KeyName" : {
					"Ref": "AnomalyDataDetectorEC2KeyPair"
				},
                "NetworkInterfaces": [
                    {
                        "GroupSet": [
                            {
                                "Ref": "AnomalyDataDetectorSecurityGroup"
                            }
                        ],
						"DeviceIndex": "0",
                        "SubnetId": {
                            "Ref": "AnomalyDataDetectorSubnet"
                        }
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash",
								"sudo apt-get update",
								"sudo apt install python3-pip -y",
								"pip install boto3",
								"sudo apt update",
								"sudo apt install ruby-full -y",
								"sudo apt install wget",
								"cd /home/ubuntu",
								"wget https://aws-codedeploy-us-east-1.s3.us-east-1.amazonaws.com/latest/install",
								"chmod +x ./install",
								"sudo ./install auto",
								"sudo service codedeploy-agent status"
                            ]
                        ]
                    }
                }
            }
        },

        "AnomalyDataDetectorDB" : {
  			"Type" : "AWS::DynamoDB::Table",
  			"Properties" : {
      			"AttributeDefinitions" : [
      			 	{
  						"AttributeName" : "deviceid",
  						"AttributeType" : "S"
					}, 
					{
  						"AttributeName" : "timestamp",
  						"AttributeType" : "S"
					}
      			 ],
      			"KeySchema" : [
      				{
                        "AttributeName": "deviceid",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "timestamp",
                        "KeyType": "RANGE"
                    }
                ],
      			"TableName" : {
					"Ref" : "AnomalyDataDetectorDynamoDBTableName"
				},
      			"ProvisionedThroughput": {
                    "ReadCapacityUnits": 2,
                    "WriteCapacityUnits": 2
                },
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
    		}
		},

		"AnomalyDataDetectorKinesisDatastream": {
			"Type" : "AWS::Kinesis::Stream",
			"Properties" : {
				"Name" : {
					"Ref" : "AnomalyDataDetectorKinesisDataStreamName"
				},
				"ShardCount" : 1,
				"Tags": [
					{
						"Key": "IdentifierTag",
						"Value": "AnomalyDataDetector"
					}
				]
			}
		},

		"AnomalyDataDetectorSNSAlertTopic": {
			"Type" : "AWS::SNS::Topic",
			"Properties" : {
				"TopicName" : {
					"Ref" : "AnomalyDataDetectorSNSAlertTopicName"
				},
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

		"AnomalyDataDetectorSNSEmailSubscription": {
			"Type" : "AWS::SNS::Subscription",
			"Properties" : {
				"Endpoint" : {
					"Ref": "AnomalyDataDetectorSubscriptionEmailID"
				},
				"Protocol" : "email",
				"TopicArn" : {
					"Ref": "AnomalyDataDetectorSNSAlertTopic"
				}
			}
		},

		"AnomalyDataDetectorS3Bucket" : {
			"Type" : "AWS::S3::Bucket",
			"Properties": {
				"BucketName": {
					"Ref" : "AnomalyDataDetectorS3BucketName"
				},
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
            }		
		},

		"AnomalyDataDetectorCodeCommitRepository": {
			"Type" : "AWS::CodeCommit::Repository",
			"Properties" : {
				"RepositoryName" : {
					"Ref": "AnomalyDataDetectorCodeCommitRepositoryName"
				},
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		},

		"AnomalyDataDetectorCodeBuildProject": {
			"Type" : "AWS::CodeBuild::Project",
			"Properties" : {
				"Name" : {
					"Ref": "AnomalyDataDetectorCodeBuildProjectName"
				},
				"Source" : {
					"Type" : "CODECOMMIT",
					"Location" : "https://git-codecommit.us-east-1.amazonaws.com/v1/repos/AnomalyDataDetector"
				},
				"Artifacts" : {
					"Type" : "S3",
					"Location" : {
						"Ref" : "AnomalyDataDetectorS3BucketName"
					},
					"Name": "/",
					"Path": ""
				},
				"ServiceRole": {
					"Fn::GetAtt": [
						"AnomalyDataDetectorCodeBuildAdminRole", "Arn"
					]
				},
				"Environment": {
					"ComputeType": "BUILD_GENERAL1_SMALL",
					"Image": "aws/codebuild/amazonlinux2-aarch64-standard:2.0",
					"ImagePullCredentialsType": "CODEBUILD",
					"Type": "ARM_CONTAINER"
				},
				"Tags": [
					{
						"Key": {
							"Ref": "AnomalyDataDetectorIdentifierTagName"
						},
						"Value": {
							"Ref": "AnomalyDataDetectorIdentifierTagValue"
						}
					}
				]
			}
		}
	},

	"Outputs" : 
	{
		"InstanceID" : {
			"Description" : "InstanceID of the EC2 Instance created",
			"Value" : { 
				"Ref" : "AnomalyDataDetectorEC2Instance" 
			}
		},
		"TopicARN" : {
			"Description" : "ARN of the m03p02_anomaly_alerts topic created",
			"Value" : { 
				"Ref" : "AnomalyDataDetectorSNSAlertTopic" 
				}
		}
	}	
}